name: CI

on:
  pull_request:
  push:
    branches: [chore/github-action] # SWITCH BEFORE PROD!

permissions:
  contents: read
  pull-requests: write

jobs:
  test-standard:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: compiler

      - name: Run Tests
        id: test
        continue-on-error: true
        working-directory: compiler
        run: cargo test --workspace

      - name: Save Result
        run: echo "${{ matrix.os }}|Standard OS|${{ steps.test.outcome }}" > result_${{ matrix.os }}.txt

      - uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.os }}
          path: result_*.txt

  test-freebsd:
    name: FreeBSD
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Test on FreeBSD
        id: freebsd
        uses: vmactions/freebsd-vm@v1
        continue-on-error: true
        with:
          usesh: true
          prepare: pkg install -y rust git cmake
          run: |
            cd compiler
            cargo test --workspace

      - name: Save Result
        run: echo "FreeBSD|VM Environment|${{ steps.freebsd.outcome }}" > result_freebsd.txt

      - uses: actions/upload-artifact@v4
        with:
          name: result-freebsd
          path: result_freebsd.txt

  test-simulated:
    name: ${{ matrix.target }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64-unknown-linux-gnu, armv7-unknown-linux-gnueabihf]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Install Cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Test via QEMU
        id: sim
        continue-on-error: true
        run: cross test --workspace --target ${{ matrix.target }} --manifest-path compiler/Cargo.toml

      - name: Save Result
        run: |
          SAFE_TARGET=$(echo "${{ matrix.target }}" | tr -d ' ')
          echo "$SAFE_TARGET|Simulated Hardware|${{ steps.sim.outcome }}" > result_$SAFE_TARGET.txt

      - uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.target }}
          path: result_*.txt

  report:
    needs: [test-standard, test-freebsd, test-simulated]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: result-*
          merge-multiple: true

      - name: Generate Report
        id: generate
        shell: bash
        run: |
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          LOGO_WASOME="https://raw.githubusercontent.com/${{ github.repository }}/$BRANCH_NAME/.github/assets/Wasome_Yellow.png"

          {
            echo "REPORT<<EOF"
            echo "<div align='center'>"
            echo "  <img src='$LOGO_WASOME' width='100' alt='Wasome Logo'>"
            echo "  <h3>Wasome Integration Report</h3>"
            echo "</div>"
            echo ""
            echo "| System Architecture | Environment Type | Status | Outcome |"
            echo "| :--- | :--- | :---: | :---: |"
          } >> $GITHUB_OUTPUT

          cat result_*.txt | sort > all_results.txt
          OVERALL_STATUS=0

          while IFS='|' read -r ENV TYPE STATUS; do
            if [ "$STATUS" == "success" ]; then
              ICON="✨" 
              TEXT="**PASS**"
            else
              ICON="❌"
              TEXT="**FAIL**"
              OVERALL_STATUS=1
            fi
            echo "| <code>$ENV</code> | $TYPE | $ICON | $TEXT |" >> $GITHUB_OUTPUT
          done < all_results.txt

          echo "EOF" >> $GITHUB_OUTPUT

          echo "FAIL_WORKFLOW=$OVERALL_STATUS" >> $GITHUB_ENV

      - name: Post Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ci-report
          message: ${{ steps.generate.outputs.REPORT }}

      - name: Check for Failures
        if: env.FAIL_WORKFLOW == '1'
        run: |
          echo "::error::One or more test matrix combinations failed."
          exit 1
